import geopandas as gpd
import matplotlib.pyplot as plt
import cartopy.crs as ccrs
import matplotlib.cm as cm
import matplotlib.colors as colors
from math import floor
from pulp import *
import cartopy.feature as cfeature
import cartopy.io.shapereader as shpreader
import matplotlib.image as mpimg
from matplotlib.offsetbox import OffsetImage, AnnotationBbox



img_petit =mpimg.imread('Taller de Progra/statics/fabrica_pequeña.png')
img_grande =mpimg.imread('Taller de Progra/statics/fabrica_grande.png')

def plot_factory_pequeña(ax, lon, lat, zoom=0.05):
    """Dibuja una fábrica en (lon, lat)"""
    imagebox = OffsetImage(img_petit, zoom=zoom)
    ab = AnnotationBbox(imagebox, (lon, lat), frameon=False, 
                        xycoords=ccrs.PlateCarree()._as_mpl_transform(ax))  
    ax.add_artist(ab)

def plot_factory_grande(ax, lon, lat, zoom=0.05):
    """Dibuja una fábrica en (lon, lat)"""
    imagebox = OffsetImage(img_grande, zoom=zoom)
    ab = AnnotationBbox(imagebox, (lon, lat), frameon=False, 
                        xycoords=ccrs.PlateCarree()._as_mpl_transform(ax))  
    ax.add_artist(ab)


ciudades_chile = {
    "Antofagasta": (-70.402, -23.650),
    "Santiago": (-70.648, -33.456),
    "Valparaíso": (-71.628, -33.047),
    "Concepción": (-73.049, -36.827),
    "Puerto Montt": (-72.942, -41.471),
    "Rancagua": (-70.74053, -34.1691)
}

ciudades_elegidas = ["Rancagua", "Antofagasta"]
plantas_elegidas = ["Pequeña", "Grande"]

# -----------------------------
# 1️⃣ Leer shapefile
# -----------------------------
# Use the correct path from the available files
gdf_santiago = gpd.read_file("Taller de Progra\Areas_Pobladas\Areas_Pobladas.shp")

# -----------------------------
# 2️⃣ Reproyectar a lat/lon (EPSG:4326)
# -----------------------------
gdf_santiago = gdf_santiago.to_crs("EPSG:4326")

# Crear mapa general
fig, ax = plt.subplots(figsize=(8, 8),
                       subplot_kw={"projection": ccrs.PlateCarree()})

# Fondo
ax.add_feature(cfeature.BORDERS, linewidth=0.5)
ax.add_feature(cfeature.COASTLINE, linewidth=0.5)
ax.add_feature(cfeature.LAND, facecolor="lightgrey")
ax.add_feature(cfeature.RIVERS, linewidth=0.5)
ax.add_feature(cfeature.LAKES, linewidth=0.5)

# Guardar coordenadas de las ciudades para calcular el zoom
all_lons, all_lats = [], []

# Dibujar todas las ciudades elegidas
i = 0
for ciudad in ciudades_elegidas:
    row = gdf_santiago[gdf_santiago["Localidad"] == ciudad].dissolve(by="Localidad")
    if row.empty:
        continue
    
    geom = row.geometry.iloc[0]
    lon, lat = geom.centroid.x, geom.centroid.y

    # Polígono de la ciudad
    ax.add_geometries([geom], crs=ccrs.PlateCarree(),
                      facecolor="lightblue", edgecolor="black", linewidth=1)

    # Fábrica
    if plantas_elegidas[i] == "Pequeña":
        plot_factory_pequeña(ax, lon, lat, zoom=0.06)
    if plantas_elegidas[i] == "Grande":
        plot_factory_grande(ax, lon, lat, zoom=0.06)

    # Nombre
    ax.text(lon, lat-0.05, ciudad, ha="center", fontsize=9,
            transform=ccrs.PlateCarree(), weight="bold")

    all_lons.append(lon)
    all_lats.append(lat)

    i +=1

# Ajustar el zoom automático a todas las ciudades
if all_lons and all_lats:
    min_lon, max_lon = min(all_lons), max(all_lons)
    min_lat, max_lat = min(all_lats), max(all_lats)
    ax.set_extent([min_lon-0.3, max_lon+0.3, min_lat-0.3, max_lat+0.3])

plt.title("Mapa de todas las fábricas construidas")

plt.show()